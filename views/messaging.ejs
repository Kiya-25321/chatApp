<!DOCTYPE html>
<html lang="en">
<head>
	<title>Messaging Page</title>
	<style>
		body {
  			background-color: #f2f2f2;
  			font-family: sans-serif;
		}
		#container {
  			width: 480px;
  			margin: auto;
		}
		.input-field {
  			width: 100%;
  			margin-top: 20px;
  			margin-bottom: 20px;
		}
		.input-field input {
  			width: 100%;
  			height: 30px;
  			padding: 0 10px;
  			border: 1px solid #ccc;
  			outline: none;
		}
		.input-field button {
  			background-color: #4CAF50;
  			border: none;
  			color: white;
  			padding: 10px 20px;
  			text-align: center;
  			text-decoration: none;
  			cursor: pointer;
  			outline: none;
		}
		.error-msg {
  			color: red;
		}
	</style>
</head>
<body>
  <%
  if(typeof contacts === 'undefined'){
    contacts = '';
  }
  if(typeof message === 'undefined'){
    message = '';
  }
  if(typeof sendBtnDisabled === 'undefined'){
    sendBtnDisabled = '';
  }
  if(typeof errorMsg === 'undefined'){
    errorMsg = '';
  }
  if (typeof token === 'undefined') {
    token = '';
  }
%>
<div id="container">
  <div class="input-field">
    <label>Contacts :</label>
    <ul id="contacts"><%= contacts %></ul>
  </div>
  <div class="input-field">
    <label>Message :</label>
    <input type="text" id="message" value="<%= message %>"/>
  </div>
  <div class="input-field">
    <button type="submit" id="send-btn" <%= sendBtnDisabled %>>Send</button>
    <button type="submit" id="refresh-btn">Refresh</button>
  </div>
  <div class="error-msg" id="error-msg"><%= errorMsg %></div>
</div>
  <script>
    let contacts = document.getElementById('contacts');
    let message = document.getElementById('message');
    let sendBtn = document.getElementById('send-btn');
    let refreshBtn = document.getElementById('refresh-btn');
    let errorMsg = document.getElementById('error-msg');
    let token = '<%= token %>';
  
    let ws = new WebSocket('ws://localhost:8082');

    ws.onopen = function() {
    console.log('Connection established');
    ws.send(JSON.stringify({
      type: 'getContacts',
      token: token
    }));
    }

    ws.onmessage = function(msg) {
    console.log(msg);
    let data = JSON.parse(msg.data);
    if (data.type === 'contacts') {
      contacts.innerHTML = '';
      data.contacts.forEach(function(contact) {
      let li = document.createElement('li');
      li.innerHTML = contact.name + ' ' + contact.number;
      contacts.appendChild(li);
      });
    }
    }
        
    message.addEventListener('input', function() {
    if (message.value.length > 0) {
      sendBtn.disabled = false;
    } else {
      sendBtn.disabled = true;
    }
    });

    sendBtn.addEventListener('click', function() {
    ws.send(JSON.stringify({
      type: 'send',
      message: message.value,
      token: token
    }));
    message.value = '';
    sendBtn.disabled = true;
    });

    refreshBtn.addEventListener('click', function() {
    ws.send(JSON.stringify({
      type: 'getContacts',
      token: token
    }));
    });

    let addContactBtn = document.createElement('button');
    let container = document.getElementById('container');

    addContactBtn.innerHTML = 'Add Contact';
    addContactBtn.id = 'add-contact-btn';

    container.appendChild(addContactBtn);

    let addContactWindow = document.createElement('div');

    addContactWindow.innerHTML = '<div class="input-field">' + '<label>Name:</label>' + '<input type="text" id="name">' + '</div>' + '<div class="input-field">' + '<label>Number:</label>' + '<input type="text" id="number">' + '</div>' + '<div class="input-field">' + '<button type="submit" id="add-contact-btn">Add Contact</button>' + '<button type="submit" id="cancel-btn">Cancel</button>' + '</div>' + '<input type="hidden" id="token" value="' + token + '">' + '<div class="error-msg" id="add-contact-error-msg"></div>';

    addContactWindow.id = 'add-contact-window';
    addContactWindow.style.display = 'none';

    container.appendChild(addContactWindow);

    let showAddContact = function() {
    addContactWindow.style.display = 'block';
    addContactBtn.style.display = 'none';
    };

    let hideAddContact = function() {
    addContactWindow.style.display = 'none';
    addContactBtn.style.display = 'block';
    };

    let nameInput = document.getElementById('name');
    let numberInput = document.getElementById('number');
    let tokenInput = document.getElementById('token');
    let addContactErrorMsg = document.getElementById('add-contact-error-msg');

    addContactBtn.addEventListener('click', showAddContact);

    addContactBtn.addEventListener('click', function() {
    let name = nameInput.value;
    let number = numberInput.value;
    let token = tokenInput.value;
    
    if (name === '' || number === '') {
      addContactErrorMsg.innerHTML = 'Name and Number are required';
    } else {
      ws.send(JSON.stringify({
      type: 'addContact',
      name: name,
      number: number,
      token: token
      }));
      addContactErrorMsg.innerHTML = '';
      nameInput.value = '';
      numberInput.value = '';
      hideAddContact();
    }
    });

    let cancelBtn = document.getElementById('cancel-btn');
    cancelBtn.addEventListener('click', hideAddContact);
	</script>
</body>
</html>